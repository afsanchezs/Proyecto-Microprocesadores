uint16_t value2,i,m,value,d0=0,d1,d2,d3,d4,d5,d6,d7,d8,d9,d10,sd1,sd2,sd3,sd4,p1,p2,p4,p8,p16=0,t[16],posicion,st1,st2,st3,st4,m1,m2,m3,m4,md;
char arreglo[20];
void setup() {
  // put your setup code here, to run once:
  Serial.begin(9600);
  pinMode(3,OUTPUT);
}

void loop() {
   if(Serial.available())
  {
    memset(arreglo, 0,sizeof(arreglo));
    while(Serial.available()>0)
    {
      delay(5);
      arreglo[posicion]=Serial.read();
      posicion++;
    }
    Serial.print("     ");
    Serial.print(atoi(arreglo)); 
    posicion=0;
  }
  value=atoi(arreglo);
 
  // put your main code here, to run repeatedly:
  d1=(value<<6)>>15;
  d2=(value<<7)>>15;
  d3=(value<<8)>>15;
  d4=(value<<9)>>15;
  d5=(value<<10)>>15;
  d6=(value<<11)>>15;
  d7=(value<<12)>>15;
  d8=(value<<13)>>15;
  d9=(value<<14)>>15;
  d10=(value<<15)>>15;
  sd1=d1+d3+d4+d6+d8+d10;
  sd2=d2+d3+d5+d6+d9+d10;
  sd3=d1+d2+d3+d7+d8+d9+d10;
  sd4=d4+d5+d6+d7+d8+d9+d10;
  if(sd1%2==0)
   {
     p1=0;
   }
  else
  {
    p1=1;
  }
  if(sd2%2==0)
   {
     p2=0;
   }
  else
  {
    p2=1;
  }
  if(sd3%2==0)
   {
     p4=0;
   }
  else
  {
    p4=1;
  }
  if(sd4%2==0)
   {
     p8=0;
   }
  else
  {
    p8=1;
  }
  m=(p1<<15)+(p2<<14)+(p4<<12)+(d1<<11)+(d2<<10)+(d3<<9)+(p8<<8)+(d4<<7)+(d5<<6)+(d6<<5)+(d7<<4)+(d8<<3)+(d9<<2)+(d10<<1);
  t[0]=m>>15;
  t[1]=(m<<1)>>15;
  t[2]=(m<<2)>>15;
  t[3]=(m<<3)>>15;
  t[4]=(m<<4)>>15;
  t[5]=(m<<5)>>15;
  t[6]=(m<<6)>>15;
  t[7]=(m<<7)>>15;
  t[8]=(m<<8)>>15;
  t[9]=(m<<9)>>15;  
  t[10]=(m<<10)>>15;
  t[11]=(m<<11)>>15;
  t[12]=(m<<12)>>15;
  t[13]=(m<<13)>>15;
  t[14]=(m<<14)>>15;
  t[15]=(m<<15)>>15;
  st1=t[0]+t[2]+t[4]+t[6]+t[8]+t[10]+t[12]+t[14];
  st2=t[1]+t[2]+t[5]+t[6]+t[9]+t[10]+t[13]+t[14];
  st3=t[3]+t[4]+t[5]+t[6]+t[11]+t[12]+t[13]+t[14];
  st4=t[7]+t[8]+t[9]+t[10]+t[11]+t[12]+t[13]+t[14];
  m1=st1%2;
  m2=st2%2;
  m3=st3%2;
  m4=st4%2;
  if((m1!=0)&&(m3!=0))
  {
    if(t[4]==0)
    {
      t[4]=1;
    }
    else
    {
      t[4]=0;
    }
  }
  if((m2!=0)&&(m3!=0))
  {
    if(t[5]==0)
    {
      t[5]=1;
    }
    else
    {
      t[5]=0;
    }
  }
  if((m1!=0)&&(m2!=0)&&(m3!=0))
  {
    if(t[6]==0)
    {
      t[6]=1;
    }
    else
    {
      t[6]=0;
    }
  }
  if((m1!=0)&&(m4!=0))
  {
    if(t[8]==0)
    {
      t[8]=1;
    }
    else
    {
      t[8]=0;
    }
  }
  if((m2!=0)&&(m4!=0))
  {
    if(t[9]==0)
    {
      t[9]=1;
    }
    else
    {
      t[9]=0;
    }
  }
  if((m1!=0)&&(m2!=0)&&(m4!=0))
  {
    if(t[10]==0)
    {
      t[10]=1;
    }
    else
    {
      t[10]=0;
    }
  }
  if((m3!=0)&&(m4!=0))
  {
    if(t[11]==0)
    {
      t[11]=1;
    }
    else
    {
      t[11]=0;
    }
  }
  if((m1!=0)&&(m3!=0)&&(m4!=0))
  {
    if(t[12]==0)
    {
      t[12]=1;
    }
    else
    {
      t[12]=0;
    }
  }
  if((m2!=0)&&(m3!=0)&&(m4!=0))
  {
    if(t[13]==0)
    {
      t[13]=1;
    }
    else
    {
      t[13]=0;
    }
  }
  if((m1!=0)&&(m2!=0)&&(m3!=0)&&(m4!=0))
  {
    if(t[14]==0)
    {
      t[14]=1;
    }
    else
    {
      t[14]=0;
    }
  }
  md=(t[4]<<9)+(t[5]<<8)+(t[6]<<7)+(t[8]<<6)+(t[9]<<5)+(t[10]<<4)+(t[11]<<3)+(t[12]<<2)+(t[13]<<1)+t[14];
  /*for(i=0;i<=15;i++)
  {
    if(t[i]==1)
    {
     analogWrite(3, 100);
    }
    else
    {
     analogWrite(3,0);
    }
  value2=analogRead(A0);
  Serial.print("Valor leido: ");
  Serial.print(value2);
  Serial.print("\n");
  delay(100);
  }
  for(i=0;i<=15;i++)
    {
      analogWrite(3,100);
      value2=analogRead(A0);
      Serial.print("Valor leido: ");
      Serial.print(value2);
      Serial.print("\n");
      delay(100);
    }*/
    
  Serial.print("\n");
  Serial.print("\n");
  Serial.print("Mensaje: ");
  Serial.print(value,BIN);
  Serial.print("\n");
  Serial.print("\n");
  Serial.print("Mensaje Codificado: ");
  Serial.print(m,BIN);
  Serial.print("\n");
  Serial.print("\n");
  Serial.print("Mensaje Decodificado: ");
  Serial.print(md,BIN);
  Serial.print("\n");
  Serial.print("\n");
  Serial.print("\n");
  delay(1000);
}
